<template>
  <div
    class="min-h-screen flex flex-col items-center justify-center gap-10 font-archivo"
  >
    <!-- Logo -->
    <div class="flex flex-col justify-center items-center">
      <p class="font-archivo text-7xl text-white">iDEKTEP</p>
      <p class="font-damion text-7xl text-idt2 relative -mt-11.5">
        photo booth
      </p>
    </div>

    <!-- 3-column layout -->
    <div class="grid grid-cols-[1fr_auto_1fr] items-start">
      <!-- frame (ทำให้ photobooth อยู่กลาง) -->
      <div class="flex flex-col gap-3">
        <div
          class="w-12 h-12 rounded-lg border-3 border-idt2 cursor-pointer transition"
        />
        <div
          class="w-12 h-12 rounded-lg border-3 border-idt2 cursor-pointer transition"
        />
        <div
          class="w-12 h-12 rounded-lg border-3 border-idt2 cursor-pointer transition"
        />
        <div
          class="w-12 h-12 rounded-lg border-3 border-idt2 cursor-pointer transition"
        />
        <div
          class="w-12 h-12 rounded-lg border-3 border-idt2 cursor-pointer transition"
        />
      </div>

      <!-- Photobooth (อยู่กลางจอจริงๆ) -->
      <div
        ref="photoboothRef"
        class="p-6 transition border-4 border-idt2 flex flex-col gap-5 items-center md:w-[383px] md:h-[540px]"
        :style="{ backgroundColor: selectedColor }"
      >
        <div class="grid grid-cols-2 gap-5">
          <img
            v-for="(img, index) in images"
            :key="index"
            :src="img"
            class="w-[220px] h-[280px] md:w-[153px] md:h-[200px] object-cover"
          >
        </div>
      </div>

      <!-- Color picker (flex อยู่ขวา) -->
      <div class="flex flex-col gap-3 ml-6">
        <div
          v-for="(c, i) in colors"
          :key="i"
          class="w-12 h-12 rounded-full border-3 cursor-pointer transition"
          :style="{
            backgroundColor: c,
            borderColor: c === selectedColor ? '#000' : '#5D416E',
          }"
          @click="changeColor(c)"
        />
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex gap-10">
      <button
        class="w-15 h-15 bg-white rounded-full flex items-center justify-center transition shadow-lg hover:bg-faded"
        @click="handleShare"
      >
        <i class="fi-rr-share"/>
      </button>
      <button
        class="w-15 h-15 bg-white rounded-full flex items-center justify-center transition shadow-lg hover:bg-faded"
        @click="handleFinish"
      >
        <i class="fi-rr-check"/>
      </button>
      <button
        class="w-15 h-15 bg-white rounded-full flex items-center justify-center transition shadow-lg hover:bg-faded"
        @click="handleDownload"
      >
        <i class="fi-rr-download"/>
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import html2canvas from "html2canvas";
import { useRouter } from 'vue-router';

const router = useRouter();
const images = ref<string[]>([]);
const selectedColor = ref<string>("#A681BA");
const photoboothRef = ref<HTMLElement | null>(null);
const isProcessing = ref(false);

const colors = [
  "#A681BA", // ม่วงพื้นหลัง
  "#4a2a77", // ม่วงเข้ม
  "#cbb7df", // ม่วงอ่อน
  "#f5f0f3", // ขาวชมพูอ่อน
  "#d9c17a", // ทอง
];

const changeColor = (color: string) => {
  selectedColor.value = color;
};

const handleFinish = async () => {
  images.value = [];
  selectedColor.value = "#A681BA";
  isProcessing.value = false;

  // ล้าง photobooth ใน sessionStorage ถ้ามี
  sessionStorage.removeItem("photoboothImages");
  router.push("/")
}

// แปลง photobooth เป็นภาพ
const capturePhotobooth = async (): Promise<Blob | null> => {
  if (!photoboothRef.value) return null;

  try {
    // รอให้ fonts โหลดเสร็จ
    await document.fonts.ready;

    // Capture element ด้วย html2canvas
    const canvas = await html2canvas(photoboothRef.value, {
      backgroundColor: selectedColor.value,
      scale: 3, // คุณภาพสูง
      useCORS: true,
      allowTaint: true,
      logging: false,
    });

    // สร้าง canvas ใหม่เพื่อเพิ่ม border รอบนอก (ไม่มี padding)
    const borderWidth = 12; // ความหนาของ border

    const finalCanvas = document.createElement("canvas");
    finalCanvas.width = canvas.width + borderWidth * 2;
    finalCanvas.height = canvas.height + borderWidth * 2;

    const ctx = finalCanvas.getContext("2d");

    if (ctx) {
      // เติมพื้นหลังสีที่เลือก
      ctx.fillStyle = selectedColor.value;
      ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

      // วาด border
      ctx.strokeStyle = "#5D416E"; // สีขอบ
      ctx.lineWidth = borderWidth;
      ctx.strokeRect(
        borderWidth / 2,
        borderWidth / 2,
        canvas.width + borderWidth,
        canvas.height + borderWidth
      );

      // วาดภาพเดิมลงไป (เว้นแค่ขนาด border)
      ctx.drawImage(canvas, borderWidth, borderWidth);
    }

    return new Promise((resolve) => {
      finalCanvas.toBlob((blob) => resolve(blob), "image/png", 1.0);
    });
  } catch (error) {
    console.error("Error capturing photobooth:", error);
    return null;
  }
};

// ฟังก์ชัน Share
const handleShare = async () => {
  isProcessing.value = true;

  try {
    const blob = await capturePhotobooth();
    if (!blob) {
      alert("ไม่สามารถสร้างภาพได้");
      return;
    }

    const file = new File([blob], "idektep-photobooth.png", {
      type: "image/png",
    });

    // ตรวจสอบว่าบราวเซอร์รองรับ Web Share API
    if (navigator.share && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: "iDEKTEP Photo Booth",
        text: "Check out my photo booth!",
      });
    } else {
      // ถ้าไม่รองรับก็ download แทน
      downloadBlob(blob, "idektep-photobooth.png");
      alert("เบราว์เซอร์ไม่รองรับการแชร์ ดาวน์โหลดภาพแทน");
    }
  } catch (error) {
    console.error("Error sharing:", error);
    alert("เกิดข้อผิดพลาดในการแชร์");
  } finally {
    isProcessing.value = false;
  }
};

// ฟังก์ชัน Download
const handleDownload = async () => {
  isProcessing.value = true;

  try {
    const blob = await capturePhotobooth();
    if (!blob) {
      alert("ไม่สามารถสร้างภาพได้");
      return;
    }

    downloadBlob(blob, "idektep-photobooth.png");
  } catch (error) {
    console.error("Error downloading:", error);
    alert("เกิดข้อผิดพลาดในการดาวน์โหลด");
  } finally {
    isProcessing.value = false;
  }
};

// ฟังก์ชันช่วยดาวน์โหลด blob
const downloadBlob = (blob: Blob, filename: string) => {
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

onMounted(() => {
  const data = sessionStorage.getItem("photoboothImages");
  if (data) {
    images.value = JSON.parse(data);
  }
});
</script>
